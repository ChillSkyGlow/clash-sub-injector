name: 构建并推送Docker镜像到GHCR

# 触发条件配置（修复格式错误，合并push配置）
on:
  # 合并push触发条件（原两个push配置合并，避免YAML格式错误）
  push:
    branches: [main, master]
    paths:
      - "src/main.py" # 修正main.py路径到/src目录
      - "pyproject.toml" # uv依赖配置
      - "Dockerfile" # 镜像构建文件
      - ".github/workflows/docker-push.yml" # 工作流本身
    tags: ["v*"] # 推送以v开头的标签（如v1.0.0）时触发
  # 手动触发（GitHub页面点击Run workflow）
  workflow_dispatch:

# 并发控制：防止同分支/标签并发推送镜像冲突
concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

# 必要权限配置
permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 配置Docker Buildx（支持多架构+构建缓存）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录GHCR（使用内置TOKEN，无需手动配置Secret）
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 提取镜像元数据（自动生成标签/标签）
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          # 标签规则：适配分支/标签/手动触发场景
          tags: |
            # main/master分支打latest标签
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
            # 标签推送时使用标签名（如v1.0.0）
            type=ref,event=tag,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # 提交哈希短码（所有场景都加，便于追溯）
            type=sha,format=short,prefix=sha-
            # 手动触发时加manual标签
            type=raw,value=manual,enable=${{ github.event_name == 'workflow_dispatch' }}
          # 标准化镜像标签
          labels: |
            org.opencontainers.image.title=${{ github.repository_name }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ github.ref_name }}

      # 构建并推送镜像（带缓存+多架构）
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 支持x86/ARM主流架构（按需删减）
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 构建缓存：加速重复构建
          cache-from: type=gha
          cache-to: type=gha,mode=max
